#Get TOP 5 customer revenue by region and fiscal year in 2021 (attached pie chart )

WITH CTE1 AS
(SELECT 
    d.region,d.customer, 
    ROUND(SUM(net_sale)/1000000,2) As total_net_sale_mil
FROM
    gdb0041.net_sale
JOIN dim_customer d
USING(customer_code)
WHERE fiscal_year = 2021
GROUP BY region, customer
ORDER BY total_net_sale_mil DESC
),
CTE2 AS
(
SELECT *,
	total_net_sale_mil*100/SUM(total_net_sale_mil) OVER (PARTITION BY region) AS contribution_pct,
    RANK () OVER (PARTITION BY region ORDER BY total_net_sale_mil DESC) AS ranking
FROM CTE1 
)
SELECT *
FROM CTE2
WHERE ranking <=5
