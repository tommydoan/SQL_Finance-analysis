#Retrieve the top 2 markets in every region by their gross sales amount in FY=2021

WITH CTE1 AS
(SELECT 
    p.division, p.product,
    SUM(sold_quantity) As total_quantity
FROM
    gdb0041.net_sale
JOIN dim_product p
USING(product_code)
WHERE fiscal_year = 2021
GROUP BY p.division, p.product
ORDER BY total_quantity DESC
),
CTE2 AS
(
SELECT *,
    RANK () OVER (PARTITION BY division ORDER BY total_quantity DESC ) AS ranking
FROM CTE1 
)
SELECT *
FROM CTE2
WHERE ranking <=2
